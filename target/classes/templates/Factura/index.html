<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" href="/css/FacturaIndex.css">
    <meta charset="UTF-8">
    <title>Factura - Encabezados</title>
</head>
<body>

<!-- 
        Validaciones
     Una factura por cliente
     Validar que el cliente exista
     Que los productos agregados cambien el stock
     Si no hay suficiente stock no deje crear la factura
     Al eliminar un producto o cliente, eliminar factura y detalle

        Vista
    Encabezado: Poner cliente 
    Detalle: productos a comprar
    boton para crear factura 
    (Validaciones antes de crear, despues de validar se crea realmente la factura)


    ----


    Lo que harÃ¡ el codigo: Validar la informacion de encabezado, y crea encabezado
    despues empieza a crear detalles, uno por uno.

    NOTA: 
        Arreglar las entidades: los atributos subtotal y total son operaciones
    por lo tanto se debe crear metodos para actualizar subtotal y total
    por si la entidad se crea vacia.

    -->

    <h1 th:text="${titulo}"></h1>

    <hr>
    <!-- Mensajes -->
    <div th:if="${Mensaje}">
        <p th:text="${Mensaje}"></p>
    </div>
    
    <div >
        <table>
            <tr>
                <th th:text="${'Factura: ' + Encabezado.id}"></th>
            </tr>
            <tr>
                <th th:text="${'Fecha de compra: ' + Encabezado.fecha}"></th>
            </tr>
            <tr>
                <th>Cliente:</th>
                <th th:text="${Encabezado.idCliente}"></th>
                <th th:text="${cliente.nombre + ' ' + cliente.apellido}"></th>
            </tr>
            <tr>
                <th>Detalles de Compra</th>
            </tr>

            <tr>
                <td>IdProducto</td>
                <td>Cantidad</td>
                <td>ValorUnitario</td>
                <td>Descuento</td>
                <td>Subtotal</td>
                <td>Total</td>
            </tr>
            <tr th:each = "Detalle : ${detalles}" th:if="${Detalle.idEncabezado==Encabezado.id}">
                <td th:text="${Detalle.idProducto}"></td>
                <td th:text="${Detalle.cantidad}"></td>
                <td th:text="${Detalle.valor}"></td>
                <td th:text="${Detalle.descuento}"></td>
                <td th:text="${Detalle.subtotal}"></td>
                <td th:text="${Detalle.total}"></td>
            </tr>

                <tr>
                    <td>Agregar Producto</td>
                </tr>
            <tr>
                <form th:action="@{/Detalle/crear}" th:object="${detalle}" method="post">
                    <input type="hidden" th:field="*{idEncabezado}" th:value="${Encabezado.id}" />
    
                    <td><input type="number"  th:field="*{idProducto}" placeholder="IdProducto" required></td>
                    <td><input type="number" min="1" th:field="*{cantidad}"  required></td>
                    <td>-</td>
                    <td><input type="number" min="0" th:field="*{descuento}"  required></td>
                    <td>-</td>
                    <td>-</td>
                    <td><button type="submit" class="btn">Agregar</button></td>
                </form>
            </tr>

            <tr>
                <th>Subtotal</th>
                <th th:text="${Encabezado.subTotal}"></th>
            </tr>
            <tr>
                <th>Total</th>
                <th th:text="${Encabezado.total}"></th>
            </tr>
            <tr>
                <th>Descuento total</th>
                <th th:text="${Encabezado.descuentottl}"></th>
            </tr>
                
        </table>
   
        <div>
            <a th:href="@{/Encabezado/eliminar/{id}(id=${Encabezado.id})}" id="btn_CancelarFactura" class= "btn">Cancelar Factura</a>
        </div>
        
        <div>
            <a th:href="@{/Detalle/finalizar/{id}(id=${Encabezado.id})}" 
            class="btn btn-success">
            Finalizar Factura
            </a>
        </div>

    </div> 

</body>
</html>